name: Deploy CRM App

on:
  push:
    branches:
      - main

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Deploy to Server
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: srv980488.hstgr.cloud
          username: ${{ secrets.SSH_USERNAME }}
          key: ${{ secrets.SSH_PRIVATE_KEY }}
          script: |
            cd /docker/crm-app-src
            git pull origin main
            docker build --no-cache \
              --build-arg NEXT_PUBLIC_SUPABASE_URL=${{ secrets.NEXT_PUBLIC_SUPABASE_URL }} \
              --build-arg NEXT_PUBLIC_SUPABASE_ANON_KEY=${{ secrets.NEXT_PUBLIC_SUPABASE_ANON_KEY }} \
              -t crm-app:latest .
            # Sync docker-compose.server.yml to deployment directory
            cp /docker/crm-app-src/docker-compose.server.yml /docker/crm-app/docker-compose.yml
            cd /docker/crm-app
            # Ensure traefik network exists
            docker network create traefik-network || true
            # Stop and remove the container, then recreate with new image
            docker stop crm-app || true
            docker rm crm-app || true
            docker compose up -d
            # Ensure Traefik can reach crm-app via traefik-network
            docker network connect traefik-network root-traefik-1 || true
            docker image prune -f
